<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create a dynamic scope for tidy evaluation — as_overscope • rlang</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>

<!-- Bootstrap -->
<link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- tidyverse -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">rlang</a>
        <small class="tidyverse">part of the <a href="http://tidyverse.org">tidyverse</a></small>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a dynamic scope for tidy evaluation</h1>
    </div>

    
    <p>Tidy evaluation works by rescoping a set of symbols (column names
of a data frame for example) to custom bindings. While doing this,
it is important to keep the original environment of captured
expressions in scope. The gist of tidy evaluation is to create a
dynamic scope containing custom bindings that should have
precedence when expressions are evaluated, and chain this scope
(set of linked environments) to the lexical enclosure of formulas
under evaluation. During tidy evaluation, formulas are transformed
into formula-promises and will self-evaluate their RHS as soon as
they are called. The main trick of tidyeval is to consistently
rechain the dynamic scope to the lexical enclosure of each tidy
quote under evaluation.</p>
    

    <pre class="usage"><span class='fu'>as_overscope</span>(<span class='no'>quo</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='kw'>NULL</span>)

<span class='fu'>new_overscope</span>(<span class='no'>bottom</span>, <span class='kw'>top</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>enclosure</span> <span class='kw'>=</span> <span class='fu'><a href='scoped_env.html'>base_env</a></span>())

<span class='fu'>overscope_eval_next</span>(<span class='no'>overscope</span>, <span class='no'>quo</span>, <span class='kw'>env</span> <span class='kw'>=</span> <span class='fu'><a href='scoped_env.html'>base_env</a></span>())

<span class='fu'>overscope_clean</span>(<span class='no'>overscope</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>quo</th>
      <td><p>A <a href='quosure.html'>quosure</a>.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>Additional data to put in scope.</p></td>
    </tr>
    <tr>
      <th>bottom</th>
      <td><p>This is the environment (or the bottom of a set of
environments) containing definitions for overscoped symbols. The
bottom environment typically contains pronouns (like <code>.data</code>)
while its direct parents contain the overscoping bindings. The
last one of these parents is the <code>top</code>.</p></td>
    </tr>
    <tr>
      <th>top</th>
      <td><p>The top environment of the overscope. During tidy
evaluation, this environment is chained and rechained to lexical
enclosures of self-evaluating formulas (or quosures). This is the
mechanism that ensures hygienic scoping: the bindings in the
overscope have precedence, but the bindings in the dynamic
environment where the tidy quotes were created in the first place
are in scope as well.</p></td>
    </tr>
    <tr>
      <th>enclosure</th>
      <td><p>The default enclosure. After a quosure is done
self-evaluating, the overscope is rechained to the default
enclosure.</p></td>
    </tr>
    <tr>
      <th>overscope</th>
      <td><p>A valid overscope containing bindings for <code>~</code>,
<code>.top_env</code> and <code>_F</code> and whose parents contain overscoped bindings
for tidy evaluation.</p></td>
    </tr>
    <tr>
      <th>env</th>
      <td><p>The lexical enclosure in case <code>quo</code> is not a validly
scoped quosure. This is the <a href='scoped_env.html'>base environment</a> by
default.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An overscope environment.</p>
<p>A valid overscope: a child environment of <code>bottom</code>
containing the definitions enabling tidy evaluation
(self-evaluating quosures, formula-unguarding, ...).</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>These functions are useful for embedding the tidy evaluation
framework in your own DSLs with your own evaluating function. They
let you create a custom dynamic scope. That is, a set of chained
environments whose bottom serves as evaluation environment and
whose top is rechained to the current lexical enclosure. But most
of the time, you can just use <code><a href='eval_tidy_.html'>eval_tidy_()</a></code> as it will take
care of installing the tidyeval components in your custom dynamic
scope.</p><ul>
<li><p><code>as_overscope()</code> is the function that powers <code><a href='eval_tidy.html'>eval_tidy()</a></code>. It
could be useful if you cannot use <code>eval_tidy()</code> for some reason,
but serves mostly as an example of how to build a dynamic scope
for tidy evaluation. In this case, it creates pronouns <code>.data</code>
and <code>.env</code> and buries all dynamic bindings from the supplied
<code>data</code> in new environments.</p></li>
<li><p><code>new_overscope()</code> is called by <code>as_overscope()</code> and
<code><a href='eval_tidy_.html'>eval_tidy_()</a></code>. It installs the definitions for making
formulas self-evaluate and for formula-guards. It also installs
the pronoun <code>.top_env</code> that helps keeping track of the boundary
of the dynamic scope. If you evaluate a tidy quote with
<code><a href='eval_tidy_.html'>eval_tidy_()</a></code>, you don't need to use this.</p></li>
<li><p><code>eval_tidy_()</code> is useful when you have several quosures to
evaluate in a same dynamic scope. That's a simple wrapper around
<code><a href='eval_bare.html'>eval_bare()</a></code> that updates the <code>.env</code> pronoun and rechains the
dynamic scope to the new formula enclosure to evaluate.</p></li>
<li><p>Once an expression has been evaluated in the tidy environment,
it's a good idea to clean up the definitions that make
self-evaluation of formulas possible <code>overscope_clean()</code>.
Otherwise your users may face unexpected results in specific
corner cases (e.g. when the evaluation environment is leaked, see
examples). Note that this function is automatically called by
<code><a href='eval_tidy_.html'>eval_tidy_()</a></code>.</p></li>
</ul>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Evaluating in a tidy evaluation environment enables all tidy</span>
<span class='co'># features:</span>
<span class='no'>expr</span> <span class='kw'>&lt;-</span> <span class='fu'>quote</span>(<span class='fu'>list</span>(<span class='no'>.data</span>$<span class='no'>cyl</span>, ~<span class='no'>letters</span>))
<span class='no'>f</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='as_quosure.html'>as_quosure</a></span>(<span class='no'>expr</span>)
<span class='no'>overscope</span> <span class='kw'>&lt;-</span> <span class='fu'>as_overscope</span>(<span class='no'>f</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>mtcars</span>)
<span class='fu'>overscope_eval_next</span>(<span class='no'>overscope</span>, <span class='no'>f</span>)</div><div class='output co'>#&gt; [[1]]
#&gt;  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4
#&gt; 
#&gt; [[2]]
#&gt; ~letters
#&gt; &lt;environment: 0x7f8494cf9628&gt;
#&gt; </div><div class='input'>
<span class='co'># However you need to cleanup the environment after evaluation.</span>
<span class='co'># Otherwise the leftover definitions for self-evaluation of</span>
<span class='co'># formulas might cause unexpected results:</span>
<span class='no'>fn</span> <span class='kw'>&lt;-</span> <span class='fu'>overscope_eval_next</span>(<span class='no'>overscope</span>, ~<span class='kw'>function</span>() ~<span class='no'>letters</span>)
<span class='fu'>fn</span>()</div><div class='output co'>#&gt; ~letters
#&gt; &lt;environment: 0x7f8494cf9628&gt;</div><div class='input'>
<span class='fu'>overscope_clean</span>(<span class='no'>overscope</span>)</div><div class='output co'>#&gt; &lt;environment: 0x7f848ae34918&gt;</div><div class='input'><span class='fu'>fn</span>()</div><div class='output co'>#&gt; ~letters
#&gt; &lt;environment: 0x7f848b4355b8&gt;</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="tidyverse">
  <p>rlang is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="http://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>Developed by <a href='http://hadley.nz'>Hadley Wickham</a>, Lionel Henry.</p>
  <p>Site built by <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67989-18', 'auto');
  ga('send', 'pageview');
</script>
      </footer>
   </div>

  </body>
</html>
