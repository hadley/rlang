<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create quosures — quosure • rlang</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>

<!-- Bootstrap -->
<link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- tidyverse -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">rlang</a>
        <small class="tidyverse">part of the <a href="http://tidyverse.org">tidyverse</a></small>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create quosures</h1>
    </div>

    
    <p>Quosures are quoted <a href='is_expr.html'>expressions</a> that keep track of an
<a href='env.html'>environment</a> (just like <a href = 'http://adv-r.had.co.nz/Functional-programming.html#closures'>closurefunctions</a>).
They are implemented as a subclass of one-sided formulas. They are
an essential piece of the tidy evaluation framework.</p><ul>
<li><p><code>quo()</code> quotes its input (i.e. captures R code without
evaluation), captures the current environment, and bundles them
in a quosure.</p></li>
<li><p><code>enquo()</code> takes a symbol referring to a function argument, quotes
the R code that was supplied to this argument, captures the
environment where the function was called (and thus where the R
code was typed), and bundles them in a quosure.</p></li>
<li><p><code><a href='quosures.html'>quos()</a></code> is a bit different to other functions as it returns a
list of quosures. You can supply several expressions directly,
e.g. <code>quos(foo, bar)</code>, but more importantly you can also supply
dots: <code>quos(...)</code>. In the latter case, expressions forwarded
through dots are captured and transformed to quosures. The
environments bundled in those quosures are the ones where the
code was supplied as arguments, even if the dots were forwarded
multiple times across several function calls.</p></li>
<li><p><code>new_quosure()</code> is the only constructor that takes its arguments
by value. It lets you create a quosure from an expression and an
environment.</p></li>
</ul>
    

    <pre class="usage"><span class='fu'>quo</span>(<span class='no'>expr</span>)

<span class='fu'>new_quosure</span>(<span class='no'>expr</span>, <span class='kw'>env</span> <span class='kw'>=</span> <span class='fu'><a href='caller_env.html'>caller_env</a></span>())

<span class='fu'>enquo</span>(<span class='no'>arg</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>expr</th>
      <td><p>An expression.</p></td>
    </tr>
    <tr>
      <th>env</th>
      <td><p>An environment specifying the lexical enclosure of the
quosure.</p></td>
    </tr>
    <tr>
      <th>arg</th>
      <td><p>A symbol referring to an argument. The expression
supplied to that argument will be captured unevaluated.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A formula whose right-hand side contains the quoted
expression supplied as argument.</p>
    
    <h2 class="hasAnchor" id="role-of-quosures-for-tidy-evaluation"><a class="anchor" href="#role-of-quosures-for-tidy-evaluation"></a>Role of quosures for tidy evaluation</h2>

    
    <p>Quosures play an essential role thanks to these features:</p><ul>
<li><p>They allow consistent scoping of quoted expressions by recording
an expression along with its local environment.</p></li>
<li><p><code>quo()</code>, <code>quos()</code> and <code>enquo()</code> all support <a href='quasiquotation.html'>quasiquotation</a>. By
unquoting other quosures, you can safely combine expressions even
when they come from different contexts. You can also unquote
values and raw expressions depending on your needs.</p></li>
<li><p>Unlike formulas, quosures self-evaluate (see <code><a href='eval_tidy.html'>eval_tidy()</a></code>)
within their own environment, which is why you can unquote a
quosure inside another quosure and evaluate it like you've
unquoted a raw expression.</p></li>
</ul>
    <p>See the <a href = 'http://dplyr.tidyverse.org/articles/programming.html'>programming withdplyr</a>
vignette for practical examples. For developers, the <a href='tidy-evaluation.html'>tidy
evaluation</a> page provides an overview of this
approach. The <a href='quasiquotation.html'>quasiquotation</a> page goes in detail over the
unquoting and splicing operators.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p><code><a href='expr.html'>expr()</a></code> for quoting a raw expression with quasiquotation.
The <a href='quasiquotation.html'>quasiquotation</a> page goes over unquoting and splicing.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># quo() is a quotation function just like expr() and quote():</span>
<span class='fu'><a href='expr.html'>expr</a></span>(<span class='fu'>mean</span>(<span class='fl'>1</span>:<span class='fl'>10</span> * <span class='fl'>2</span>))</div><div class='output co'>#&gt; mean(1:10 * 2)</div><div class='input'><span class='fu'>quo</span>(<span class='fu'>mean</span>(<span class='fl'>1</span>:<span class='fl'>10</span> * <span class='fl'>2</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~mean(1:10 * 2)</div><div class='input'>
<span class='co'># It supports quasiquotation and allows unquoting (evaluating</span>
<span class='co'># immediately) part of the quoted expression:</span>
<span class='fu'>quo</span>(<span class='fu'>mean</span>(!! <span class='fl'>1</span>:<span class='fl'>10</span> * <span class='fl'>2</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~mean(c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20))</div><div class='input'>
<span class='co'># What makes quo() often safer to use than quote() and expr() is</span>
<span class='co'># that it keeps track of the contextual environment. This is</span>
<span class='co'># especially important if you're referring to local variables in</span>
<span class='co'># the expression:</span>
<span class='no'>var</span> <span class='kw'>&lt;-</span> <span class='st'>"foo"</span>
<span class='no'>quo</span> <span class='kw'>&lt;-</span> <span class='fu'>quo</span>(<span class='no'>var</span>)
<span class='no'>quo</span></div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~var</div><div class='input'>
<span class='co'># Here `quo` quotes `var`. Let's check that it also captures the</span>
<span class='co'># environment where that symbol is defined:</span>
<span class='fu'>identical</span>(<span class='fu'><a href='get_env.html'>get_env</a></span>(<span class='no'>quo</span>), <span class='fu'><a href='get_env.html'>get_env</a></span>())</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'><span class='fu'><a href='env_has.html'>env_has</a></span>(<span class='no'>quo</span>, <span class='st'>"var"</span>)</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'>

<span class='co'># Keeping track of the environment is important when you quote an</span>
<span class='co'># expression in a context (that is, a particular function frame)</span>
<span class='co'># and pass it around to other functions (which will be run in their</span>
<span class='co'># own evaluation frame):</span>
<span class='no'>fn</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>() {
  <span class='no'>foobar</span> <span class='kw'>&lt;-</span> <span class='fl'>10</span>
  <span class='fu'>quo</span>(<span class='no'>foobar</span> * <span class='fl'>2</span>)
}
<span class='no'>quo</span> <span class='kw'>&lt;-</span> <span class='fu'>fn</span>()
<span class='no'>quo</span></div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~foobar * 2</div><div class='input'>
<span class='co'># `foobar` is not defined here but was defined in `fn()`'s</span>
<span class='co'># evaluation frame. However, the quosure keeps track of that frame</span>
<span class='co'># and is safe to evaluate:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='no'>quo</span>)</div><div class='output co'>#&gt; [1] 20</div><div class='input'>

<span class='co'># Like other formulas, quosures are normally self-quoting under</span>
<span class='co'># evaluation:</span>
<span class='fu'>eval</span>(~<span class='no'>var</span>)</div><div class='output co'>#&gt; ~var
#&gt; &lt;environment: 0x7f848e1aab48&gt;</div><div class='input'><span class='fu'>eval</span>(<span class='fu'>quo</span>(<span class='no'>var</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~var</div><div class='input'>
<span class='co'># But eval_tidy() evaluates expressions in a special environment</span>
<span class='co'># (called the overscope) where they become promises. They</span>
<span class='co'># self-evaluate under evaluation:</span>
<span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(~<span class='no'>var</span>)</div><div class='output co'>#&gt; ~var
#&gt; &lt;environment: 0x7f848e1aab48&gt;</div><div class='input'><span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='fu'>quo</span>(<span class='no'>var</span>))</div><div class='output co'>#&gt; [1] "foo"</div><div class='input'>
<span class='co'># Note that it's perfectly fine to unquote quosures within</span>
<span class='co'># quosures, as long as you evaluate with eval_tidy():</span>
<span class='no'>quo</span> <span class='kw'>&lt;-</span> <span class='fu'>quo</span>(<span class='no'>letters</span>)
<span class='no'>quo</span> <span class='kw'>&lt;-</span> <span class='fu'>quo</span>(<span class='fu'>toupper</span>(!! <span class='no'>quo</span>))
<span class='no'>quo</span></div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~toupper(~letters)</div><div class='input'><span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='no'>quo</span>)</div><div class='output co'>#&gt;  [1] "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M" "N" "O" "P" "Q" "R" "S"
#&gt; [20] "T" "U" "V" "W" "X" "Y" "Z"</div><div class='input'>

<span class='co'># Quoting as a quosure is necessary to preserve scope information</span>
<span class='co'># and make sure objects are looked up in the right place. However,</span>
<span class='co'># there are situations where it can get in the way. This is the</span>
<span class='co'># case when you deal with non-tidy NSE functions that do not</span>
<span class='co'># understand formulas. You can inline the RHS of a formula in a</span>
<span class='co'># call thanks to the UQE() operator:</span>
<span class='no'>nse_function</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>arg</span>) <span class='fu'>substitute</span>(<span class='no'>arg</span>)
<span class='no'>var</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='with_env.html'>locally</a></span>(<span class='fu'>quo</span>(<span class='fu'>foo</span>(<span class='no'>bar</span>)))
<span class='fu'>quo</span>(<span class='fu'>nse_function</span>(<span class='fu'><a href='quasiquotation.html'>UQ</a></span>(<span class='no'>var</span>)))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~nse_function(~foo(bar))</div><div class='input'><span class='fu'>quo</span>(<span class='fu'>nse_function</span>(<span class='fu'><a href='quasiquotation.html'>UQE</a></span>(<span class='no'>var</span>)))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~nse_function(foo(bar))</div><div class='input'>
<span class='co'># This is equivalent to unquoting and taking the RHS:</span>
<span class='fu'>quo</span>(<span class='fu'>nse_function</span>(!! <span class='fu'><a href='set_expr.html'>get_expr</a></span>(<span class='no'>var</span>)))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~nse_function(foo(bar))</div><div class='input'>
<span class='co'># One of the most important old-style NSE function is the dollar</span>
<span class='co'># operator. You need to use UQE() for subsetting with dollar:</span>
<span class='no'>var</span> <span class='kw'>&lt;-</span> <span class='fu'>quo</span>(<span class='no'>cyl</span>)
<span class='fu'>quo</span>(<span class='no'>mtcars</span>$<span class='fu'><a href='quasiquotation.html'>UQE</a></span>(<span class='no'>var</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~mtcars$cyl</div><div class='input'>
<span class='co'># `!!`() is also treated as a shortcut. It is meant for situations</span>
<span class='co'># where the bang operator would not parse, such as subsetting with</span>
<span class='co'># $. Since that's its main purpose, we've made it a shortcut for</span>
<span class='co'># UQE() rather than UQ():</span>
<span class='no'>var</span> <span class='kw'>&lt;-</span> <span class='fu'>quo</span>(<span class='no'>cyl</span>)
<span class='fu'>quo</span>(<span class='no'>mtcars</span>$<span class='fu'>`!!`</span>(<span class='no'>var</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~mtcars$cyl</div><div class='input'>

<span class='co'># When a quosure is printed in the console, the brackets indicate</span>
<span class='co'># if the enclosure is the global environment or a local one:</span>
<span class='fu'><a href='with_env.html'>locally</a></span>(<span class='fu'>quo</span>(<span class='no'>foo</span>))</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~foo</div><div class='input'>
<span class='co'># Literals are enquosed with the empty environment because they can</span>
<span class='co'># be evaluated anywhere. The brackets indicate "empty":</span>
<span class='fu'>quo</span>(<span class='fl'>10L</span>)</div><div class='output co'>#&gt; &lt;quosure: empty&gt;
#&gt; ~10L</div><div class='input'>
<span class='co'># To differentiate local environments, use str(). It prints the</span>
<span class='co'># machine address of the environment:</span>
<span class='no'>quo1</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='with_env.html'>locally</a></span>(<span class='fu'>quo</span>(<span class='no'>foo</span>))
<span class='no'>quo2</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='with_env.html'>locally</a></span>(<span class='fu'>quo</span>(<span class='no'>foo</span>))
<span class='no'>quo1</span>; <span class='no'>quo2</span></div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~foo</div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~foo</div><div class='input'><span class='fu'>str</span>(<span class='no'>quo1</span>); <span class='fu'>str</span>(<span class='no'>quo2</span>)</div><div class='output co'>#&gt; &lt;quosure: local 0x7f8493c467b8&gt;
#&gt; ~foo</div><div class='output co'>#&gt; &lt;quosure: local 0x7f848d038db8&gt;
#&gt; ~foo</div><div class='input'>
<span class='co'># You can also see this address by printing the environment at the</span>
<span class='co'># console:</span>
<span class='fu'><a href='get_env.html'>get_env</a></span>(<span class='no'>quo1</span>)</div><div class='output co'>#&gt; &lt;environment: 0x7f8493c467b8&gt;</div><div class='input'><span class='fu'><a href='get_env.html'>get_env</a></span>(<span class='no'>quo2</span>)</div><div class='output co'>#&gt; &lt;environment: 0x7f848d038db8&gt;</div><div class='input'>

<span class='co'># new_quosure() takes by value an expression that is already quoted:</span>
<span class='no'>expr</span> <span class='kw'>&lt;-</span> <span class='fu'>quote</span>(<span class='no'>mtcars</span>)
<span class='no'>env</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='as_env.html'>as_env</a></span>(<span class='st'>"datasets"</span>)
<span class='no'>quo</span> <span class='kw'>&lt;-</span> <span class='fu'>new_quosure</span>(<span class='no'>expr</span>, <span class='no'>env</span>)
<span class='no'>quo</span></div><div class='output co'>#&gt; &lt;quosure: local&gt;
#&gt; ~mtcars</div><div class='input'><span class='fu'><a href='eval_tidy.html'>eval_tidy</a></span>(<span class='no'>quo</span>)</div><div class='output co'>#&gt;                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
#&gt; Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
#&gt; Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
#&gt; Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
#&gt; Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
#&gt; Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
#&gt; Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
#&gt; Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
#&gt; Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
#&gt; Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
#&gt; Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
#&gt; Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
#&gt; Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
#&gt; Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
#&gt; Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
#&gt; Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
#&gt; Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
#&gt; Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
#&gt; Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
#&gt; Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
#&gt; Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
#&gt; Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
#&gt; Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
#&gt; AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
#&gt; Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
#&gt; Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
#&gt; Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
#&gt; Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
#&gt; Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
#&gt; Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
#&gt; Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
#&gt; Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
#&gt; Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#role-of-quosures-for-tidy-evaluation">Role of quosures for tidy evaluation</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="tidyverse">
  <p>rlang is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="http://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>Developed by <a href='http://hadley.nz'>Hadley Wickham</a>, Lionel Henry.</p>
  <p>Site built by <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67989-18', 'auto');
  ga('send', 'pageview');
</script>
      </footer>
   </div>

  </body>
</html>
